@page
@model Blockchain_Testing.Pages.BlockchainModel
@using System.Text.Json;
@using BlockchainCore;
@{
    ViewData["Title"] = "Blockchain Transactions";
}

<!-- Sử dụng Tailwind CSS để có giao diện đẹp và responsive -->
<script src="https://cdn.tailwindcss.com"></script>
<style>
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f7fafc;
    }

    .card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
</style>

<div class="container mx-auto p-4">
    <h1 class="text-3xl font-bold text-center text-blue-700 mb-6">Tất cả giao dịch trên Blockchain</h1>

    <!-- HIỂN THỊ TRẠNG THÁI HỢP LỆ CỦA CHUỖI -->
    @if (!Model.IsChainValid)
    {
        <!-- Cảnh báo nếu chuỗi không hợp lệ -->
        <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-md shadow-md" role="alert">
            <p class="font-bold">Trạng thái chuỗi blockchain</p>
            <p>⚠️ CẢNH BÁO: Chuỗi blockchain **KHÔNG HỢP LỆ**! Có thể đã bị can thiệp.</p>
        </div>
    }
    else if (Model.AllTransactions == null || !Model.AllTransactions.Any())
    {
        <!-- Thông báo khi chỉ có khối Genesis -->
        <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-6 rounded-md shadow-md" role="alert">
            <p class="font-bold">Trạng thái chuỗi blockchain</p>
            <p>ℹ️ Chuỗi blockchain đã được khởi tạo thành công với **khối Genesis**. Hiện chưa có giao dịch nào được mine.</p>
        </div>
    }
    else
    {
        <!-- Thông báo khi có nhiều khối và chuỗi hợp lệ -->
        <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-6 rounded-md shadow-md" role="alert">
            <p class="font-bold">Trạng thái chuỗi blockchain</p>
            <p>✅ Chuỗi blockchain **HỢP LỆ** và toàn vẹn!</p>
        </div>
    }

    @if (Model.AllTransactions != null && Model.AllTransactions.Any())
    {
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            @foreach (var transaction in Model.AllTransactions)
            {
                CvData cvData = null;
                try
                {
                    cvData = JsonSerializer.Deserialize<CvData>(transaction.Data);
                }
                catch (Exception)
                {
                    // Bỏ qua lỗi phân tích, hiển thị thông báo lỗi thân thiện hơn
                }

                <div class="card bg-white rounded-xl shadow-lg p-6 border-2 border-gray-200">
                    <h5 class="text-xl font-semibold text-blue-600 mb-2">Chi tiết giao dịch</h5>

                    @if (cvData != null)
                    {
                        <div class="mb-4">
                            <p class="text-sm font-medium text-gray-500">Tên CV:</p>
                            <p class="text-lg font-semibold text-gray-900">@cvData.Title</p>
                        </div>
                        <div class="mb-4">
                            <p class="text-sm font-medium text-gray-500">Ngày tạo:</p>
                            <p class="text-lg text-gray-900">@cvData.CreatedAt.ToString("dd MMMM yyyy HH:mm")</p>
                        </div>
                    }
                    else
                    {
                        <p class="text-sm text-red-500 mb-4">
                            <strong>Lỗi:</strong> Không thể hiển thị chi tiết giao dịch.
                        </p>
                    }

                    <hr class="my-4" />

                    <div class="space-y-2">
                        <p class="text-sm">
                            <strong class="font-semibold">Từ:</strong> <span class="text-gray-700">@transaction.FromAddress</span>
                        </p>
                        <p class="text-sm">
                            <strong class="font-semibold">Đến:</strong> <span class="text-gray-700">@transaction.ToAddress</span>
                        </p>
                        <div class="mt-4">
                            <p class="text-sm font-semibold">ID Giao dịch (Hash):</p>
                            <p class="text-xs text-gray-600 font-mono break-all bg-gray-100 p-2 rounded-md">
                                @transaction.TransactionId
                            </p>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <p class="text-muted text-center">Chưa có giao dịch nào được mine. Hãy thêm và mine block mới!</p>
    }
</div>

@functions {
    public class CvData
    {
        public int Id { get; set; }
        public string Title { get; set; }
        public DateTime CreatedAt { get; set; }
        public int UserId { get; set; }
        public string PublicKey { get; set; }
    }
}
